
<project name="services-trunk" default="package" basedir=".">
    <description>
        collectionspace services
    </description>
  <!-- set global properties for this build -->
    <property file="build.properties" />
    <property name="mvn.opts" value="" />
    <property name="src" location="src"/>
    <property name="build" location="build"/>
    <property name="dist"  location="dist"/>

    <property name="db" value="mysql"/>
    <property name="db.script.dir" location="${basedir}/src/main/resources/scripts/db/${db}"/>



    <condition property="osfamily-unix">
        <os family="unix" />
    </condition>
    <condition property="osfamily-windows">
        <os family="windows" />
    </condition>

    <target name="init" depends="setup">
    <!-- Create the time stamp -->
        <tstamp/>
    <!-- Create the build directory structure used by compile -->
        <mkdir dir="${build}"/>

    </target>

    <target name="compile" depends="init"
        description="compile the source " >
    <!-- Compile the java code from ${src} into ${build} -->
        <javac srcdir="${src}" destdir="${build}"/>

    </target>

    <target name="dist" depends="package"
    description="generate cspace service an nuxeo distribution">
        <!-- Create the distribution directory -->
        <mkdir dir="${dist}"/>
        <antcall name="dist-cspace"/>
        <antcall name="dist-nuxeo"/>
    </target>

    <target name="dist-cspace" depends="package"
    description="generate cspace service distribution">

        <tar destfile="${dist}/${jboss.release}.${cspace.services.release}.tar.gz" compression="gzip">
            <tarfileset dir="${basedir}/services"
              preserveLeadingSlashes="true">
                <include name="/services/JaxRsServiceProvider/target/*.war"/>
                <exclude name="server/${jboss.domain.cspace}/tmp/**"/>
                <exclude name="server/${jboss.domain.cspace}/deploy/helloworld.war"/>
            </tarfileset>
            <tarfileset dir="${src}/main/resources"
              preserveLeadingSlashes="true">
                <exclude name="schemas/**"/>
            </tarfileset>

        </tar>
    </target>

    <target name="dist-nuxeo" depends="compile"
        description="generate nuxeo domain distribution" >
        <fail message="JBoss is not installed or ${jboss.dir} not found">
            <condition>
                <not>
                    <available file="${jboss.dir}" type="dir"/>
                </not>
            </condition>
        </fail>

        <fail message="Nuxeo is not deployed or ${nuxeo.deploy} not found">
            <condition>
                <not>
                    <available file="${nuxeo.deploy}" type="dir"/>
                </not>
            </condition>
        </fail>


        <tar destfile="${dist}/${jboss.release}.${nuxeo.release}.tar.gz" compression="gzip">
            <tarfileset dir="${jboss.dir}"
              preserveLeadingSlashes="true">
                <exclude name="server/${jboss.domain.nuxeo}/log/**"/>
                <exclude name="server/${jboss.domain.nuxeo}/tmp/**"/>
                <exclude name="server/${jboss.domain.nuxeo}/deploy/cspace*.*"/>
            </tarfileset>
            <tarfileset dir="${src}/main/resources"
              preserveLeadingSlashes="true">
                <exclude name="schemas/**"/>
            </tarfileset>

        </tar>
    </target>

    <target name="package" depends="setup,package-unix,package-windows"
  description="Package CollectionSpace Services" />
    <target name="package-unix" if="osfamily-unix">
        <exec executable="mvn" failonerror="true">
            <arg value="package" />
            <arg value="-Dmaven.test.skip=true" />
            <arg value="-f" />
            <arg value="${basedir}/pom.xml" />
            <arg value="-N" />
            <arg value="${mvn.opts}" />
        </exec>
    </target>
    <target name="package-windows" if="osfamily-windows">
        <exec executable="cmd" failonerror="true">
            <arg value="/c" />
            <arg value="mvn.bat" />
            <arg value="package" />
            <arg value="-Dmaven.test.skip=true" />
            <arg value="-f" />
            <arg value="${basedir}/pom.xml" />
            <arg value="-N" />
            <arg value="${mvn.opts}" />
        </exec>
    </target>


    <target name="clean" depends="clean-unix,clean-windows"
  description="Delete target directories" >
        <delete dir="${build}"/>
        <delete dir="${dist}"/>
    </target>
    <target name="clean-unix" if="osfamily-unix">
        <exec executable="mvn" failonerror="true">
            <arg value="clean" />
            <arg value="${mvn.opts}" />
        </exec>
    </target>
    <target name="clean-windows" if="osfamily-windows">
        <exec executable="cmd" failonerror="true">
            <arg value="/c" />
            <arg value="mvn.bat" />
            <arg value="clean" />
            <arg value="${mvn.opts}" />
        </exec>
    </target>

    <target name="test" depends="test-unix,test-windows" description="Run tests" />
    <target name="test-unix" if="osfamily-unix">
        <exec executable="mvn" failonerror="true">
            <arg value="test" />
            <arg value="${mvn.opts}" />
        </exec>
    </target>
    <target name="test-windows" if="osfamily-windows">
        <exec executable="cmd" failonerror="true">
            <arg value="/c" />
            <arg value="mvn.bat" />
            <arg value="test" />
            <arg value="${mvn.opts}" />
        </exec>
    </target>

    <target name="create_db"
    description="create database(s), grant privileges to test users"
    depends="setup">
        <sql driver="com.mysql.jdbc.Driver"
        url="jdbc:mysql://localhost:3306/cspace"
        userid="root"
        password="admin"
        src="${db.script.dir}/init_db.sql"
        >
            <classpath>
                <pathelement path="${jboss.lib.cspace}/mysql-connector-java-5.1.7-bin.jar"/>
            </classpath>
        </sql>
    </target>

    <target name="deploy" depends="package"
    description="deploy services in ${jboss.server.cspace}">
        <ant antfile="services/build.xml" target="deploy" inheritall="false"/>
        <ant antfile="3rdparty/build.xml" target="deploy" inheritall="false"/>
        <copy file="${basedir}/target/${cspace-services.war}" todir="${jboss.lib.cspace}"/>
    </target>

    <target name="undeploy" depends="setup"
    description="undeploy authentication service from ${jboss.server.cspace}">
        <ant antfile="services/build.xml" target="undeploy" inheritall="false"/>
        <ant antfile="3rdparty/build.xml" target="undeploy" inheritall="false"/>
        <delete file="${jboss.lib.cspace}/${cspace-services.war}"/>
    </target>


    <target name="eclipse" depends="eclipse-unix,eclipse-windows" description="Generate Eclipse files" />
    <target name="eclipse-unix" if="osfamily-unix">
        <exec executable="mvn" failonerror="true">
            <arg value="eclipse:clean" />
            <arg value="eclipse:eclipse" />
            <arg value="${mvn.opts}" />
        </exec>
        <exec executable="fixeclipse" failonerror="true" />
    </target>
    <target name="eclipse-windows" if="osfamily-windows">
        <exec executable="cmd" failonerror="true">
            <arg value="/c" />
            <arg value="mvn.bat" />
            <arg value="eclipse:clean" />
            <arg value="eclipse:eclipse" />
            <arg value="${mvn.opts}" />
        </exec>
    </target>


</project>
